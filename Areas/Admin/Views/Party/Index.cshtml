@model AccountingSuite.Models.Common.PaginatedList<AccountingSuite.Models.Master.Party>

@{
    ViewData["Title"] = "Admin - Parties";
    
}

@if (TempData["Message"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Message"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="d-flex justify-content-between align-items-end mb-2">
    <div class="d-flex align-items-end gap-2">
        <h2 class="mb-0">Party List</h2>
    </div>

    <div class="w-50">
        <form asp-action="Index" method="get" class="d-flex gap-2" id="searchForm">
            <input type="text" id="searchTerm" name="searchTerm" class="form-control form-control-sm border-dark"
                placeholder="Enter keywords to get Party Details" value="@ViewData["CurrentFilter"]" />
            <button type="submit" class="btn btn-sm btn-primary">Search</button>
            <a asp-action="Index" class="btn btn-sm btn-outline-secondary">Reset</a>
        </form>
    </div>
</div>

<nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a asp-controller="Home" asp-action="Index">Home</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            Party List
        </li>   
    </ol>
</nav>

<!-- Party Action buttons -->
<div class="d-flex flex-wrap gap-2 mb-3 w-100">
    <!-- State filter + View Party -->
    <form asp-action="Index" method="get" class="d-flex gap-2 w-50">
        <select name="stateId" asp-items="ViewBag.States" asp-for="@ViewData["SelectedState"]" class="form-select form-select-sm border-dark w-100 ">
    <option value="">-- Select State --</option>
</select>
        <button type="submit" class="btn btn-sm btn-outline-primary text-nowrap">View Parties</button>
    </form>

    <!-- View All Parties -->
    <a asp-action="Index" class="btn btn-sm btn-success text-center text-nowrap">View All Parties</a>

    <!-- Add Party (modal trigger) -->
  <a class="btn btn-primary btn-sm" asp-action="Create">Add Party</a>
</div>





<div class="table-responsive">
    <table class="table table-pill table-sm table-hover mt-2 align-middle">
        <thead class="table-light">
            <tr>
                <th>Party Code</th>
                <th>Name</th>
                <th>Party Type</th>
                <th>GSTIN</th>
                <th>Contact Number</th>
                <th>State</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in Model)
            {
                <tr>
                    <td>@p.PartyCode</td>
                    <td>@p.Name</td>
                    <td>@(p.PartyType == AccountingSuite.Models.Master.Party.PartyTypeEnum.Both ? "Customer & Vendor" :
                                            p.PartyType.ToString())</td>
                    <td>@p.GSTIN</td>
                    <td>@p.ContactNumber</td>
                    <td>@p.StateName</td>
                    <td>
                        @if (p.IsActive)
                        {
                            <span class="badge bg-success">Active</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">Inactive</span>
                        }
                    </td>
                    <td>
                       <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item">
                                     <a href="javascript:void(0)"
                                onclick="loadDetails(@p.PartyId)" class="text-primary">Details</a>
                                </li>
                                <li class="breadcrumb-item">
                                     <a href="@Url.Action("Edit", "Party", new { area = "Admin", id = p.PartyId })"
                                class="text-warning">Edit</a>
                                </li>
                                 <li class="breadcrumb-item">
                                      <a href="javascript:void(0)" 
                                onclick="loadDelete(@p.PartyId)" class="text-danger">Delete</a>
                                </li> 
                            </ol>
                        </nav>
                   
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="d-flex justify-content-center align-items-center gap-3 mt-3">
    @if (Model.HasPreviousPage)
    {
        <a asp-action="Index" asp-route-pageNumber="@(Model.PageIndex - 1)"
            asp-route-searchTerm="@ViewData["CurrentFilter"]" class="text-primary">&lt;Prev</a>
    }
    else
    {

        <span class="text-muted">&lt;Prev</span>
    }

    <span class="fw-regular">
        @if (Model.TotalCount == 0)
        {
            <span class="fw-semibold">No records found</span>
        }
        else
        {

            <span>Showing @Model.StartRecord–@Model.EndRecord of @Model.TotalCount records</span>
        }
    </span>

    @if (Model.HasNextPage)
    {
        <a asp-action="Index" asp-route-pageNumber="@(Model.PageIndex + 1)"
            asp-route-searchTerm="@ViewData["CurrentFilter"]" class="text-primary">Next&gt;</a>
    }
    else
    {

        <span class="text-muted">Next&gt;</span>
    }
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body" id="detailsContent"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="partyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body" id="deleteContent"></div>
        </div>
    </div>
</div>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function loadDetails(partyId) {
            $.get('/Admin/Party/Details/' + partyId, function (data) {
                $('#detailsContent').html(data);
                $('#detailsModal').modal('show');
            }).fail(function () {
                alert('Unable to load Party details.');
            });
        }

        function loadDelete(partyId) {
            $.get('/Admin/Party/Delete/' + partyId, function (data) {
                $('#deleteContent').html(data);
                $('#deleteModal').modal('show');
            }).fail(function () {
                alert('Unable to load delete confirmation.');
            });
        }

         $(document).on("submit", "#deleteForm", function (e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr("action"),
                type: "POST",
                data: form.serialize(),
                success: function (response) {
                    if (response.success) {
                        $('#deleteModal').modal('hide');
                        location.reload(); // refresh table
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert("Error deleting Party.");
                }
            });
        });
    </script>
}
