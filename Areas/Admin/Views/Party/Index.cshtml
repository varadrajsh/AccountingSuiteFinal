@model AccountingSuite.Models.Common.PaginatedList<AccountingSuite.Models.Master.Party>

@{
    ViewData["Title"] = "Admin - Parties";
}

@if (TempData["Message"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        @TempData["Message"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="d-flex justify-content-between align-items-end mb-2">
    <!-- Left block: Party List + Add Party -->
    <div class="d-flex align-items-end gap-2">
        <h2 class="mb-0">Party List</h2>
        <a class="btn btn-primary btn-sm" asp-action="Create">Add Party</a>
    </div>

    <!-- Right block: Search Party form -->
    <div class="w-50">
        <form asp-action="Index" method="get" class="d-flex gap-2" id="searchForm">
            <input type="text" id="searchTerm" name="searchTerm" class="form-control form-control-sm border-dark"
                   placeholder="Enter keywords to get Party Details" value="@ViewData["CurrentFilter"]" />
            <button type="submit" class="btn btn-sm btn-primary">Search</button>
            <a asp-action="Index" class="btn btn-sm btn-outline-secondary">Reset</a>
        </form>
    </div>
</div>

<nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a asp-controller="Home" asp-action="Index">Home</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            Party List
        </li>
    </ol>
</nav>

<div class="table-responsive">
    <table class="table table-pill table-sm table-hover mt-2">
        <thead>
            <tr>
                <th>Party Code</th>
                <th>Name</th>
                <th>Party Type</th>
                <th>GSTIN</th>
                <th>Contact Number</th>
                <th>Email</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in Model)
            {
                <tr>
                    <td>@p.PartyCode</td>
                    <td>@p.Name</td>
                    <td>@p.PartyType</td>
                    <td>@p.GSTIN</td>
                    <td>@p.ContactNumber</td>
                    <td>@p.Email</td>
                    <td>
                        @if (p.IsActive)
                        {
                            <span class="badge bg-success">Active</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">Inactive</span>
                        }
                    </td>
                    <td>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item">
                                    <a href="javascript:void(0)" class="text-primary" data-bs-toggle="modal"
                                       data-bs-target="#detailsModal" onclick="loadDetails(@p.PartyId)">Details</a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a href="@Url.Action("Edit", "Party", new { area = "Admin", id = p.PartyId })"
                                       class="text-secondary edit-party">Edit</a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a href="javascript:void(0)" class="text-danger" data-bs-toggle="modal"
                                       data-bs-target="#deleteModal" onclick="loadDelete(@p.PartyId)">Delete</a>
                                </li>
                            </ol>
                        </nav>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-center align-items-center gap-3 mt-3">
    @if (Model.HasPreviousPage)
    {
        <a asp-action="Index" asp-route-pageNumber="@(Model.PageIndex - 1)" asp-route-searchTerm="@ViewData["CurrentFilter"]" class="text-primary">&lt;Prev</a>
    }
    else
    {
        <span class="text-muted">&lt;Prev</span>
    }

    <span class="fw-regular">
        @if (Model.TotalCount == 0)
        {
            <span class="fw-semibold">No records found</span>
        }
        else
        {
            <span>Showing @Model.StartRecord–@Model.EndRecord of @Model.TotalCount records</span>
        }
    </span>

    @if (Model.HasNextPage)
    {
        <a asp-action="Index" asp-route-pageNumber="@(Model.PageIndex + 1)" asp-route-searchTerm="@ViewData["CurrentFilter"]" class="text-primary">Next&gt;</a>
    }
    else
    {
        <span class="text-muted">Next&gt;</span>
    }
</div>

<!-- Modals -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-body" id="detailsContent"></div></div></div>
</div>

<div class="modal fade" id="partyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-body" id="modalBody"></div></div></div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content"><div class="modal-body" id="deleteContent"></div></div></div>
</div>

@section Scripts {
    <script>
        function loadDetails(id) {
            $("#detailsContent").load('/Admin/Party/Details/' + id);
        }
        function loadDelete(id) {
            $("#deleteContent").load('/Admin/Party/Delete/' + id);
        }

        // ✅ Edit modal AJAX
        $(document).on("click", ".edit-party", function (e) {
            e.preventDefault();
            var url = $(this).attr("href");
            $.get(url, function (data) {
                $("#modalBody").html(data);
                $("#partyModal").modal("show");
            });
        });

        $(document).on("submit", "#editForm", function (e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr("action"),
                type: form.attr("method"),
                data: form.serialize(),
                success: function (response) {
                    if (response.success) {
                        $("#partyModal").modal("hide");
                        location.reload();
                    } else {
                        $("#modalBody").html(response);
                    }
                }
            });
        });

        // ✅ Delete modal AJAX
        $(document).on("submit", "#deleteForm", function (e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr("action"),
                type: form.attr("method"),
                data: form.serialize(),
                success: function (response) {
                    if (response.success) {
                        $("#deleteModal").modal("hide");
                        location.reload();
                    } else {
                        alert(response.message || 'Delete failed.');
                    }
                },
                error: function () {
                    alert('Failed to delete.');
                }
            });
        });

        // ✅ Focus search input on page load
        $(document).ready(function () {
            $('#searchTerm').focus();
        });

        // ✅ ESC key clears search box and reloads full Party list
        $(document).on('keydown', function (e) {
            if (e.key === "Escape") {
                $('#searchTerm').val('');
                $('#searchForm').submit();
            }
        });
    </script>
}
